(function(){var n={};var o=40;var p=38;var q=27;var r=13;function parseOptions(a){return a.options==null?a.split(","):a.options}tinymce.create('tinymce.plugins.AutoCompletePlugin',{setOptions:function(a){n.options=parseOptions(a)},getOptions:function(){return n.options},init:function(l,m){n={list:createOptionList(),visible:false,cancelEnter:false,delimiter:l.getParam('autocomplete_delimiters','160,32').split(","),options:parseOptions(l.getParam('autocomplete_options','')),optionsUrl:parseOptions(l.getParam('autocomplete_options_url',false)),trigger:l.getParam('autocomplete_trigger','@'),enclosing:l.getParam('autocomplete_end_option','')};function keyUpEvent(a,e){if((!n.visible&&e.keyCode!=q&&e.keyCode!=r)||(e.keyCode!=o&&e.keyCode!=p&&e.keyCode!=r&&e.keyCode!=q)){var b=getCurrentWord(a);var c=[];if(b.length>0){populateList(b)}if(b.length==0||c.length==0){hideOptionList()}}}function populateList(d){var e=d.replace(n.trigger,"");if(n.optionsUrl){if(e.length<=1)return false;jQuery.ajax({type:"GET",url:n.optionsUrl,cache:false,data:"q="+e,success:function(a){var b=JSON.parse(a);if(b.ok&&b.DATA){var c=[];for(var i in b.DATA){if(b.DATA[i].name)c.push(b.DATA[i].name)}n.options=c;matches=matchingOptions(e);if(matches.length>0){displayOptionList(matches,e,l);highlightNextOption()}}else{}},error:function(a,b){}})}else{matches=matchingOptions(e);if(matches.length>0){displayOptionList(matches,e,l);highlightNextOption()}}}function keyPressEvent(a,e){if(e.keyCode==r&&n.cancelEnter){n.cancelEnter=false;return tinymce.dom.Event.cancel(e)}}function keyDownEvent(a,e){if(n.visible){if(e.keyCode==o){highlightNextOption();return tinymce.dom.Event.cancel(e)}if(e.keyCode==p){highlightPreviousOption();return tinymce.dom.Event.cancel(e)}if(e.keyCode==r){selectOption(a,getCurrentWord(a));n.cancelEnter=true;return}if(e.keyCode==q){hideOptionList();return tinymce.dom.Event.cancel(e)}}}function clickEvent(a,e){hideOptionList()}function displayOptionList(a,b,c){var d="";var e=new RegExp("("+b+")");for(var i in a){if(a[i].key!=null){d+="<li data-value='"+a[i].key+"'>"+a[i].key.replace(e,"<mark>$1</mark>")+" "+a[i].description+"</li>"}else{d+="<li data-value='"+a[i]+"'>"+a[i].replace(e,"<mark>$1</mark>")+"</li>"}}jQuery(n.list).html(d);var f=jQuery(c.getContainer()).position();var g=jQuery(c.getContainer()).find(".mceToolbar").first();var h=jQuery(c.selection.getNode()).position();var j=0;var k=0;if(c.selection.getRng().getClientRects().length>0){j=c.selection.getRng().getClientRects()[0].top+c.selection.getRng().getClientRects()[0].height;k=c.selection.getRng().getClientRects()[0].left}else{j=parseInt(jQuery(c.selection.getNode()).css("font-size"))*1.3+h.top;k=h.left}jQuery(n.list).css("margin-top",f.top+g.innerHeight()+j);jQuery(n.list).css("margin-left",f.left+k);jQuery(n.list).css("display","block");n.visible=true;optionListEventHandlers(c)}function optionListEventHandlers(a){jQuery(n.list).find("li").hover(function(){jQuery(n.list).find("[data-selected=true]").attr("data-selected","false");jQuery(this).attr("data-selected","true")});jQuery(n.list).find("li").click(function(){selectOption(a,getCurrentWord(a))})}function createOptionList(){var a=document.createElement("ul");jQuery(a).addClass("auto-list");document.body.appendChild(a);return a}function hideOptionList(){jQuery(n.list).css("display","none");n.visible=false}function highlightNextOption(){var a=jQuery(n.list).find("[data-selected=true]");if(a.size()==0||a.next().size()==0){jQuery(n.list).find("li:first-child").attr("data-selected","true")}else{a.next().attr("data-selected","true")}a.attr("data-selected","false")}function highlightPreviousOption(){var a=jQuery(n.list).find("[data-selected=true]");if(a.size()==0||a.prev().size()==0){jQuery(n.list).find("li:last-child").attr("data-selected","true")}else{a.prev().attr("data-selected","true")}a.attr("data-selected","false")}function selectOption(a,b){var c=jQuery(n.list).find("[data-selected=true]").attr("data-value");if(c==null){c=jQuery(n.list).find("li:first-child").attr("data-value")}var d=restOfContent(a.selection.getSel().anchorNode,"");var e=a.selection.getSel().anchorNode.textContent;var f=a.selection.getRng();f.setStart(f.startContainer,f.startOffset-b.length);a.selection.setRng(f);var g="";if(n.delimiter.length>0){g=String.fromCharCode(n.delimiter[0])}a.selection.setContent(n.trigger+c+g);if(n.enclosing.length>0&&!closingTextExists(d,e)){var h=a.selection.getBookmark();a.selection.setContent(g+n.trigger+n.enclosing);a.selection.moveToBookmark(h)}hideOptionList()}function closingTextExists(a,b){var c=n.trigger+n.enclosing;a=a.substr(b.length);var d=new RegExp(n.trigger+".{"+n.enclosing.length+"}","g").exec(a);if(d!=null&&d.length>0&&d[0]==c){return true}return false}function restOfContent(a,b){b+=a.textContent;if(a.nextSibling!=null){return restOfContent(a.nextSibling,b)}return b}function matchingOptions(a){var b=n.options;var c=[];for(var i in b){if(b[i].key==null&&(a.length==0||beginningOfWordMatches(a,b[i]))){c.push(b[i])}else if(b[i].key!=null&&(a.length==0||beginningOfWordMatches(a,b[i].key))){c.push(b[i])}}return c}function beginningOfWordMatches(a,b){return(b.match("^"+a)==a)}function getCurrentWord(a){var b=a.selection.getSel().focusNode==null?"":a.selection.getSel().focusNode.nodeValue;var c=a.selection.getSel().focusOffset;if(b==null||b.length==0){return""}var d=0;for(var i=0;i<c;i++){if(n.delimiter.indexOf(b.charCodeAt(i).toString())!=-1){d=i+1}}var e=b.substr(d,c-d);if(e.length>0&&e.charAt(0).toString()==n.trigger){return e}return""}l.onKeyUp.addToTop(keyUpEvent);l.onKeyDown.addToTop(keyDownEvent);l.onKeyPress.addToTop(keyPressEvent);l.onClick.add(clickEvent)},getInfo:function(){return{longname:'AutoComplete',author:'Mijura Pty Ltd',authorurl:'http://mijura.com',infourl:'http://blog.mijura.com',version:tinymce.majorVersion+"."+tinymce.minorVersion}}});tinymce.PluginManager.add('autocomplete',tinymce.plugins.AutoCompletePlugin)})();